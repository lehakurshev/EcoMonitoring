name: Deploy EcoMonitoring

on:
  push:
    branches:
      - main

env:
  MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
  VITE_ADMIN_PASSWORD_HASH: ${{ secrets.VITE_ADMIN_PASSWORD_HASH }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker..."

            if ! command -v docker >/dev/null 2>&1; then
              echo "‚ùå Docker –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker $USER
            fi

            if ! command -v docker-compose >/dev/null 2>&1; then
              echo "‚ùå docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.25.0/docker-compose-linux-x86_64" \
                -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "‚úÖ Docker –∏ docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

            mkdir -p ${{ secrets.DEPLOY_PATH }}
            cd ${{ secrets.DEPLOY_PATH }}

            if [ ! -d ".git" ]; then
              echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
              git clone https://github.com/${{ github.repository }} .
            else
              echo "üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º"
              git fetch origin
              git checkout main
              git reset --hard origin/main
              git clean -fd
            fi

            chmod +x deploy.sh
            ./deploy.sh ${{ secrets.DEPLOY_PATH }}

          EOF
